<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NuLimit مدیریت - پنل ادمین</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#050814;
      --card:rgba(10,12,30,0.86);
      --stroke:rgba(148,163,184,0.22);
      --text:#f9fafb;
      --muted:#a1a5c3;
      --accent:#fbbf24;
      --accent2:#6366f1;
      --danger:#ef4444;
      --ok:#22c55e;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Vazirmatn',system-ui,-apple-system,sans-serif;
      background:radial-gradient(circle at top, #192045 0, #050814 55%, #02030a 100%);
      color:var(--text);
      min-height:100vh;
      padding:14px;
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .topbar{
      background:linear-gradient(135deg,rgba(255,255,255,0.08),rgba(15,23,42,0.85));
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      backdrop-filter:blur(18px);
      box-shadow:0 18px 50px rgba(15,23,42,0.85);
    }
    .brand{
      display:flex;align-items:center;gap:10px;
    }
    .logo{
      width:40px;height:40px;border-radius:999px;
      background:conic-gradient(from 210deg,#facc15,#fb7185,#a855f7,#38bdf8,#facc15);
      padding:2px;
      flex:0 0 auto;
    }
    .logo > div{
      width:100%;height:100%;border-radius:inherit;
      background:radial-gradient(circle at 20% 0,#1f2937,#020617);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;
    }
    .brand h1{font-size:16px;font-weight:650;line-height:1.1}
    .brand p{font-size:11px;color:var(--muted);margin-top:2px}

    .actions{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
      justify-content:flex-start;
    }
    .pill{
      border:1px solid var(--stroke);
      background:rgba(15,23,42,0.65);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      outline:none;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:9px 12px;
      font-size:12px;
      font-weight:650;
      cursor:pointer;
      color:#0b1220;
      background:linear-gradient(135deg,#fbbf24,#f97316);
      box-shadow:0 12px 28px rgba(251,191,36,0.22);
      transition:transform .12s, filter .12s, box-shadow .12s;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.05);box-shadow:0 16px 35px rgba(251,191,36,0.28)}
    .btn:active{transform:translateY(0)}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none;filter:none;box-shadow:none}
    .btn2{
      background:linear-gradient(135deg,#4f46e5,#a855f7);
      color:#f9fafb;
      box-shadow:0 12px 28px rgba(79,70,229,0.22);
    }
    .btnDanger{
      background:linear-gradient(135deg,#ef4444,#b91c1c);
      color:#fff;
      box-shadow:0 12px 28px rgba(239,68,68,0.18);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1.2fr;
      gap:12px;
    }
    @media (max-width:860px){
      .grid{grid-template-columns:1fr}
    }

    .panel{
      background:linear-gradient(135deg,rgba(255,255,255,0.06),rgba(15,23,42,0.86));
      border:1px solid var(--stroke);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 18px 50px rgba(15,23,42,0.75);
      backdrop-filter:blur(18px);
      min-height:520px;
      display:flex;
      flex-direction:column;
    }
    .panelHeader{
      padding:12px 12px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .panelHeader .title{
      display:flex;flex-direction:column;gap:3px;
    }
    .panelHeader .title span:first-child{
      font-size:13px;font-weight:650;
    }
    .panelHeader .title span:last-child{
      font-size:11px;color:var(--muted);
    }
    .panelBody{
      flex:1;
      min-height:0;
    }

    /* Conversations list */
    .convList{
      padding:10px;
      overflow:auto;
      height:100%;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .convItem{
      border:1px solid rgba(148,163,184,0.18);
      background:rgba(2,6,23,0.45);
      border-radius:14px;
      padding:10px 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      transition:transform .08s, border-color .12s, background .12s;
    }
    .convItem:hover{transform:translateY(-1px);border-color:rgba(129,140,248,0.55)}
    .convItem.active{
      border-color:rgba(251,191,36,0.65);
      background:linear-gradient(135deg,rgba(99,102,241,0.18),rgba(251,191,36,0.14));
    }
    .convMain{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .convName{
      font-size:13px;
      font-weight:650;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .convLast{
      font-size:11px;color:var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:260px;
    }
    .convMeta{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:6px;
      flex:0 0 auto;
    }
    .badgeNew{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(34,197,94,0.14);
      color:#4ade80;
      border:1px solid rgba(34,197,94,0.18);
    }
    .metaTime{
      font-size:11px;color:var(--muted);
      direction:ltr;
    }

    /* Chat */
    .chat{
      height:100%;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .chatHeadRight{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-start;
    }
    .chatInfo{
      font-size:12px;color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:320px;
    }
    .chatMessages{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,0.05),rgba(15,23,42,0.92));
    }
    .empty{
      text-align:center;
      color:var(--muted);
      font-size:12px;
      margin-top:34px;
      line-height:1.7;
    }
    .row{display:flex;width:100%;}
    .row.user{justify-content:flex-start;}
    .row.admin{justify-content:flex-end;}
    .bubble{
      max-width:80%;
      padding:8px 10px 7px;
      border-radius:14px;
      font-size:12px;
      line-height:1.7;
      white-space:pre-wrap;
      word-break:break-word;
      position:relative;
    }
    .bubble.user{
      background:rgba(30,64,175,0.9);
      border-bottom-right-radius:5px;
    }
    .bubble.admin{
      background:linear-gradient(135deg,#fbbf24,#f97316);
      color:#111827;
      border-bottom-left-radius:5px;
    }
    .t{
      margin-top:2px;
      font-size:10px;
      opacity:.78;
      direction:ltr;
      text-align:left;
    }
    .chatInput{
      border-top:1px solid var(--stroke);
      padding:10px;
      display:flex;
      gap:8px;
      background:linear-gradient(to right,rgba(15,23,42,0.98),rgba(17,24,39,0.98));
    }
    .ta{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.95);
      color:var(--text);
      padding:9px 12px;
      font-size:12px;
      outline:none;
      resize:none;
      max-height:80px;
      min-height:38px;
    }

    .footNote{
      padding:10px 12px;
      font-size:11px;
      color:var(--muted);
      border-top:1px solid var(--stroke);
      background:rgba(2,6,23,0.25);
    }
    .err{
      padding:10px 12px;
      font-size:12px;
      color:var(--danger);
      border-top:1px solid var(--stroke);
      background:rgba(239,68,68,0.06);
      display:none;
      line-height:1.6;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .ok{
      color:#86efac;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><div>N</div></div>
        <div>
          <h1>NuLimit مدیریت</h1>
          <p>مشاهده و پاسخ به پیام‌های کاربران</p>
        </div>
      </div>

      <div class="actions">
        <input id="searchInput" class="pill" placeholder="جستجو آیدی/پیام..." />
        <button id="refreshBtn" class="btn" type="button">رفرش</button>
        <span id="statusPill" class="pill" style="border-color:rgba(34,197,94,0.25);color:#86efac;background:rgba(34,197,94,0.10)">آنلاین</span>
      </div>
    </div>

    <div class="grid">
      <!-- Conversations -->
      <div class="panel">
        <div class="panelHeader">
          <div class="title">
            <span>لیست گفتگوها</span>
            <span id="convCount">۰ گفتگو</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <span class="pill" id="selectedLabel">هیچ گفتگویی انتخاب نشده</span>
          </div>
        </div>
        <div class="panelBody">
          <div id="convList" class="convList">
            <div class="empty">در حال دریافت گفتگوها...</div>
          </div>
        </div>
        <div class="err" id="adminError"></div>
        <div class="footNote">
          نکته: حذف گفتگو، تمام پیام‌ها را هم پاک می‌کند.
        </div>
      </div>

      <!-- Chat -->
      <div class="panel">
        <div class="panelHeader">
          <div class="title">
            <span>چت</span>
            <span id="chatSub">روی یک گفتگو بزنید تا پیام‌ها نمایش داده شود.</span>
          </div>

          <div class="chatHeadRight">
            <button id="markReadBtn" class="btn btn2" type="button" disabled>خوانده شد</button>
            <button id="deleteBtn" class="btn btnDanger" type="button" disabled>حذف گفتگو</button>
          </div>
        </div>

        <div class="panelBody chat">
          <div id="chatMessages" class="chatMessages">
            <div class="empty">هنوز گفتگویی انتخاب نشده است.</div>
          </div>

          <div class="chatInput">
            <textarea id="replyInput" class="ta" rows="1" placeholder="پاسخ خود را بنویسید..." disabled></textarea>
            <button id="sendBtn" class="btn btn2" type="button" disabled>ارسال پاسخ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // ==========================
    // 1) Firebase Config
    // ==========================
    const firebaseConfig = {
      apiKey: "AIzaSyDLGZW1MwhWfREMcsIS__h1Czygsn8VLBU",
      authDomain: "nulimit-support.firebaseapp.com",
      projectId: "nulimit-support",
      storageBucket: "nulimit-support.firebasestorage.app",
      messagingSenderId: "325154539382",
      appId: "1:325154539382:web:06d02a36452866c15f9c57",
      measurementId: "G-F8DN4LMKKG"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ==========================
    // 2) UI refs
    // ==========================
    const convListEl = document.getElementById('convList');
    const convCountEl = document.getElementById('convCount');
    const selectedLabel = document.getElementById('selectedLabel');
    const chatSub = document.getElementById('chatSub');
    const chatMessagesEl = document.getElementById('chatMessages');

    const searchInput = document.getElementById('searchInput');
    const refreshBtn = document.getElementById('refreshBtn');
    const statusPill = document.getElementById('statusPill');

    const replyInput = document.getElementById('replyInput');
    const sendBtn = document.getElementById('sendBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const markReadBtn = document.getElementById('markReadBtn');

    const adminErrorEl = document.getElementById('adminError');

    function setError(msg) {
      if (!msg) {
        adminErrorEl.style.display = 'none';
        adminErrorEl.textContent = '';
        return;
      }
      adminErrorEl.style.display = 'block';
      adminErrorEl.textContent = msg;
    }

    function setOnline(isOnline) {
      if (isOnline) {
        statusPill.textContent = 'آنلاین';
        statusPill.style.borderColor = 'rgba(34,197,94,0.25)';
        statusPill.style.color = '#86efac';
        statusPill.style.background = 'rgba(34,197,94,0.10)';
      } else {
        statusPill.textContent = 'آفلاین';
        statusPill.style.borderColor = 'rgba(239,68,68,0.25)';
        statusPill.style.color = '#fecaca';
        statusPill.style.background = 'rgba(239,68,68,0.10)';
      }
    }

    function fmtTime(ts) {
      try {
        const d = ts && ts.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
        if (!d) return '';
        return d.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
      } catch {
        return '';
      }
    }

    function fmtDateTime(ts) {
      try {
        const d = ts && ts.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
        if (!d) return '';
        return d.toLocaleString('fa-IR', { hour: '2-digit', minute: '2-digit', year: 'numeric', month: '2-digit', day: '2-digit' });
      } catch {
        return '';
      }
    }

    function escapeText(s) {
      return (s ?? '').toString();
    }

    // ==========================
    // 3) State
    // ==========================
    let selectedConvId = null;
    let selectedConvData = null;

    let unsubConvs = null;
    let unsubMsgs = null;

    // برای فیلتر ساده سمت کلاینت
    let allConvsCache = [];

    // ==========================
    // 4) Conversations subscribe/render
    // ==========================
    function renderConversations(list) {
      convListEl.innerHTML = '';

      if (!list.length) {
        convListEl.innerHTML = '<div class="empty">گفتگویی یافت نشد.</div>';
        convCountEl.textContent = '۰ گفتگو';
        return;
      }

      convCountEl.textContent = `${list.length} گفتگو`;

      list.forEach(item => {
        const { id, data } = item;
        const displayId = data.displayId || data.userId || id;
        const lastMessage = data.lastMessage || '';
        const lastTs = data.lastTimestamp || data.createdAt || null;
        const unread = !!data.unreadForAdmin;

        const el = document.createElement('div');
        el.className = 'convItem' + (id === selectedConvId ? ' active' : '');
        el.dataset.id = id;

        const left = document.createElement('div');
        left.className = 'convMain';

        const name = document.createElement('div');
        name.className = 'convName';
        name.textContent = displayId;

        const last = document.createElement('div');
        last.className = 'convLast';
        last.textContent = lastMessage;

        left.appendChild(name);
        left.appendChild(last);

        const right = document.createElement('div');
        right.className = 'convMeta';

        if (unread) {
          const b = document.createElement('div');
          b.className = 'badgeNew';
          b.textContent = 'جدید';
          right.appendChild(b);
        } else {
          // جایگزین برای هم‌تراز شدن
          const spacer = document.createElement('div');
          spacer.style.height = '0px';
          right.appendChild(spacer);
        }

        const t = document.createElement('div');
        t.className = 'metaTime';
        t.textContent = fmtTime(lastTs);
        right.appendChild(t);

        el.appendChild(left);
        el.appendChild(right);

        el.addEventListener('click', () => selectConversation(id, data));
        convListEl.appendChild(el);
      });
    }

    function applySearchAndRender() {
      const q = (searchInput.value || '').trim().toLowerCase();
      if (!q) {
        renderConversations(allConvsCache);
        return;
      }

      const filtered = allConvsCache.filter(({ id, data }) => {
        const displayId = (data.displayId || data.userId || id || '').toString().toLowerCase();
        const lastMessage = (data.lastMessage || '').toString().toLowerCase();
        return displayId.includes(q) || lastMessage.includes(q) || id.toLowerCase().includes(q);
      });

      renderConversations(filtered);
    }

    function subscribeConversations() {
      if (unsubConvs) unsubConvs();

      convListEl.innerHTML = '<div class="empty">در حال دریافت گفتگوها...</div>';
      setError('');

      const ref = db.collection('conversations').orderBy('lastTimestamp', 'desc');

      unsubConvs = ref.onSnapshot(snap => {
        setOnline(true);

        const list = [];
        snap.forEach(doc => list.push({ id: doc.id, data: doc.data() || {} }));
        allConvsCache = list;

        applySearchAndRender();

        // اگر گفتگو انتخاب شده و هنوز وجود دارد، label را آپدیت کن
        if (selectedConvId) {
          const found = list.find(x => x.id === selectedConvId);
          if (found) {
            selectedConvData = found.data;
            selectedLabel.textContent = 'انتخاب شده: ' + (found.data.displayId || found.data.userId || selectedConvId);
          } else {
            // حذف شده
            clearSelection();
          }
        }

      }, err => {
        console.error(err);
        setOnline(false);
        setError('خطا در دریافت گفتگوها:\n' + (err.code || '') + ' ' + (err.message || ''));
      });
    }

    // ==========================
    // 5) Select conversation + messages
    // ==========================
    function clearSelection() {
      selectedConvId = null;
      selectedConvData = null;

      selectedLabel.textContent = 'هیچ گفتگویی انتخاب نشده';
      chatSub.textContent = 'روی یک گفتگو بزنید تا پیام‌ها نمایش داده شود.';
      chatMessagesEl.innerHTML = '<div class="empty">هنوز گفتگویی انتخاب نشده است.</div>';

      replyInput.value = '';
      replyInput.disabled = true;
      sendBtn.disabled = true;
      deleteBtn.disabled = true;
      markReadBtn.disabled = true;

      if (unsubMsgs) { unsubMsgs(); unsubMsgs = null; }

      // رندر لیست برای برداشتن active
      applySearchAndRender();
    }

    async function selectConversation(convId, data) {
      setError('');
      selectedConvId = convId;
      selectedConvData = data || {};

      const displayId = selectedConvData.displayId || selectedConvData.userId || convId;

      selectedLabel.textContent = 'انتخاب شده: ' + displayId;
      chatSub.textContent = 'گفتگو با: ' + displayId + ' — ' + (selectedConvData.deviceId ? ('device: ' + selectedConvData.deviceId) : '');
      deleteBtn.disabled = false;
      markReadBtn.disabled = false;

      replyInput.disabled = false;
      sendBtn.disabled = false;
      replyInput.focus();

      // رندر لیست برای active
      applySearchAndRender();

      // mark as read for admin (best effort)
      try {
        await db.collection('conversations').doc(convId).set({ unreadForAdmin: false }, { merge: true });
      } catch (e) {
        console.warn('mark read failed:', e);
      }

      subscribeMessages(convId);
    }

    function subscribeMessages(convId) {
      if (unsubMsgs) unsubMsgs();

      chatMessagesEl.innerHTML = '<div class="empty">در حال دریافت پیام‌ها...</div>';

      const msgsRef = db
        .collection('conversations').doc(convId)
        .collection('messages')
        .orderBy('createdAt', 'asc');

      unsubMsgs = msgsRef.onSnapshot(snap => {
        chatMessagesEl.innerHTML = '';
        if (snap.empty) {
          chatMessagesEl.innerHTML = '<div class="empty">هنوز پیامی در این گفتگو وجود ندارد.</div>';
          return;
        }

        snap.forEach(doc => {
          const m = doc.data() || {};
          const row = document.createElement('div');
          row.className = 'row ' + (m.sender === 'admin' ? 'admin' : 'user');

          const bubble = document.createElement('div');
          bubble.className = 'bubble ' + (m.sender === 'admin' ? 'admin' : 'user');
          bubble.textContent = escapeText(m.text);

          const t = document.createElement('div');
          t.className = 't';
          t.textContent = fmtTime(m.createdAt);

          bubble.appendChild(t);
          row.appendChild(bubble);
          chatMessagesEl.appendChild(row);
        });

        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight + 200;

      }, err => {
        console.error(err);
        setError('خطا در دریافت پیام‌ها:\n' + (err.code || '') + ' ' + (err.message || ''));
      });
    }

    // ==========================
    // 6) Send admin reply
    // ==========================
    async function sendAdminMessage() {
      setError('');
      if (!selectedConvId) return;

      const text = (replyInput.value || '').trim();
      if (!text) return;

      sendBtn.disabled = true;

      const convRef = db.collection('conversations').doc(selectedConvId);
      const msgsRef = convRef.collection('messages');

      const batch = db.batch();
      batch.set(msgsRef.doc(), {
        text,
        sender: 'admin',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      batch.set(convRef, {
        lastMessage: text,
        lastTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
        unreadForUser: true,
        unreadForAdmin: false
      }, { merge: true });

      try {
        await batch.commit();
        replyInput.value = '';
        replyInput.focus();
      } catch (e) {
        console.error(e);
        setError('ارسال انجام نشد:\n' + (e.code || '') + ' ' + (e.message || ''));
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener('click', sendAdminMessage);
    replyInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendAdminMessage();
      }
    });

    // ==========================
    // 7) Mark read
    // ==========================
    markReadBtn.addEventListener('click', async () => {
      setError('');
      if (!selectedConvId) return;

      try {
        await db.collection('conversations').doc(selectedConvId).set({
          unreadForAdmin: false
        }, { merge: true });
      } catch (e) {
        console.error(e);
        setError('خوانده‌شدن ثبت نشد:\n' + (e.code || '') + ' ' + (e.message || ''));
      }
    });

    // ==========================
    // 8) Delete conversation (deep delete messages + conv doc)
    // ==========================
    async function deleteConversationDeep(convId) {
      if (!convId) return;

      const name = (selectedConvData && (selectedConvData.displayId || selectedConvData.userId)) ? (selectedConvData.displayId || selectedConvData.userId) : convId;
      const ok = confirm(`گفتگو "${name}" حذف شود؟\n(تمام پیام‌ها پاک می‌شود)`);
      if (!ok) return;

      setError('');
      deleteBtn.disabled = true;
      markReadBtn.disabled = true;
      sendBtn.disabled = true;
      replyInput.disabled = true;

      // قطع listener پیام‌ها تا وسط حذف دوباره رندر نکنه
      if (unsubMsgs) { unsubMsgs(); unsubMsgs = null; }

      const convRef = db.collection('conversations').doc(convId);
      const msgsCol = convRef.collection('messages');

      try {
        // حذف پیام‌ها در batch های < 500
        while (true) {
          const snap = await msgsCol
            .orderBy(firebase.firestore.FieldPath.documentId())
            .limit(450)
            .get();

          if (snap.empty) break;

          const batch = db.batch();
          snap.docs.forEach(d => batch.delete(d.ref));
          await batch.commit();
        }

        await convRef.delete();

        // پاک کردن UI
        clearSelection();
        setError('گفتگو حذف شد.').toString;

      } catch (e) {
        console.error(e);
        setError('حذف انجام نشد:\n' + (e.code || '') + ' ' + (e.message || ''));
        // برگرداندن UI
        deleteBtn.disabled = false;
        markReadBtn.disabled = false;
        replyInput.disabled = false;
        sendBtn.disabled = false;
        // دوباره پیام‌ها را سابسکرایب کن
        subscribeMessages(convId);
      }
    }

    deleteBtn.addEventListener('click', () => deleteConversationDeep(selectedConvId));

    // ==========================
    // 9) Search + refresh
    // ==========================
    searchInput.addEventListener('input', applySearchAndRender);
    refreshBtn.addEventListener('click', () => {
      setError('');
      subscribeConversations();
      if (selectedConvId) subscribeMessages(selectedConvId);
    });

    // ==========================
    // 10) Boot
    // ==========================
    subscribeConversations();
  </script>
</body>
</html>
